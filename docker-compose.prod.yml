# Optional override for Linux servers — enables MAC address resolution.
# Without this overlay everything works (polling, scanning, SNMP) —
# only ARP/MAC detection requires host network access.
#
# Linux only: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
# Does NOT work on macOS/Windows Docker Desktop.

services:
  db:
    ports:
      - "127.0.0.1:5432:5432"

  redis:
    ports:
      - "127.0.0.1:6379:6379"

  backend:
    network_mode: host
    networks: !reset {}
    environment:
      POSTGRES_SERVER: "127.0.0.1"
      REDIS_URL: "redis://127.0.0.1:6379/0"
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      KAFKA_BOOTSTRAP_SERVERS: "127.0.0.1:9092"
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://127.0.0.1:4318/v1/traces"
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-infrascope}
      ML_SERVICE_URL: "http://127.0.0.1:8010"
      POLLING_SERVICE_URL: "http://127.0.0.1:8011"
      DISCOVERY_SERVICE_URL: "http://127.0.0.1:8012"
      NETWORK_CONTROL_SERVICE_URL: "http://127.0.0.1:8013"

  ml-service:
    network_mode: host
    networks: !reset {}
    environment:
      POSTGRES_SERVER: "127.0.0.1"
      REDIS_URL: "redis://127.0.0.1:6379/0"
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      KAFKA_BOOTSTRAP_SERVERS: "127.0.0.1:9092"
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://127.0.0.1:4318/v1/traces"
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-infrascope}

  polling-service:
    network_mode: host
    networks: !reset {}
    environment:
      POSTGRES_SERVER: "127.0.0.1"
      REDIS_URL: "redis://127.0.0.1:6379/0"
      POLLING_SERVICE_ENABLED: "false"
      DISCOVERY_SERVICE_ENABLED: "false"
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      KAFKA_BOOTSTRAP_SERVERS: "127.0.0.1:9092"
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://127.0.0.1:4318/v1/traces"
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-infrascope}

  discovery-service:
    network_mode: host
    networks: !reset {}
    environment:
      REDIS_URL: "redis://127.0.0.1:6379/0"
      POLLING_SERVICE_ENABLED: "false"
      DISCOVERY_SERVICE_ENABLED: "false"
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      KAFKA_BOOTSTRAP_SERVERS: "127.0.0.1:9092"
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://127.0.0.1:4318/v1/traces"
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-infrascope}

  network-control-service:
    network_mode: host
    networks: !reset {}
    environment:
      POSTGRES_SERVER: "127.0.0.1"
      REDIS_URL: "redis://127.0.0.1:6379/0"
      POLLING_SERVICE_ENABLED: "false"
      DISCOVERY_SERVICE_ENABLED: "false"
      NETWORK_CONTROL_SERVICE_ENABLED: "false"
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      KAFKA_BOOTSTRAP_SERVERS: "127.0.0.1:9092"
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://127.0.0.1:4318/v1/traces"
      OTEL_SERVICE_NAMESPACE: ${OTEL_SERVICE_NAMESPACE:-infrascope}

  kafka:
    network_mode: host
    networks: !reset {}
    ports: !reset []
    environment:
      KAFKA_NODE_ID: "1"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://127.0.0.1:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@127.0.0.1:9093"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"

  kafka-ui:
    network_mode: host
    networks: !reset {}
    ports: !reset []
    environment:
      KAFKA_CLUSTERS_0_NAME: infrascope
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: 127.0.0.1:9092

  jaeger:
    network_mode: host
    networks: !reset {}
    ports: !reset []

  frontend:
    extra_hosts:
      - "backend:host-gateway"
