name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.14"
  NODE_VERSION: "22"

jobs:
  validate-descriptors:
    name: Validate Service Descriptors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Validate schema
        run: uv run python tools/scaffold/validate_service_descriptors.py

  build-service-matrix:
    name: Build Service Matrix
    runs-on: ubuntu-latest
    needs: validate-descriptors
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Install dependencies
        run: uv sync --frozen
      - id: matrix
        name: Build matrix json
        run: echo "matrix=$(uv run python tools/scaffold/build_service_matrix.py)" >> "$GITHUB_OUTPUT"

  service-ci:
    name: Service CI
    needs: build-service-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-service-matrix.outputs.matrix) }}
    uses: ./.github/workflows/service-ci-reusable.yml
    with:
      service_name: ${{ matrix.name }}
      lint_command: ${{ matrix.lint }}
      test_command: ${{ matrix.test }}

  frontend-test:
    name: Frontend Test
    runs-on: ubuntu-latest
    needs: service-ci
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:run

  frontend-e2e:
    name: Frontend E2E Smoke
    runs-on: ubuntu-latest
    needs: frontend-test
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Run Playwright smoke tests
        run: npm run test:e2e

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-test
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  platform-docker-build:
    name: Platform Docker Build
    runs-on: ubuntu-latest
    needs: [service-ci, frontend-build, frontend-e2e]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: infrascope-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: false
          tags: infrascope-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  service-cd-preview:
    name: Service CD Preview
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: platform-docker-build
    strategy:
      fail-fast: false
      matrix:
        service_name: [backend, worker, ml-service, polling-service, discovery-service, network-control-service]
    uses: ./.github/workflows/service-cd-reusable.yml
    with:
      service_name: ${{ matrix.service_name }}
      image_tag: ${{ github.sha }}
